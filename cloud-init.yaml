#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - git
  - nginx
  - certbot
  - python3-certbot-nginx
  - postgresql-client
  - redis-tools
  - ufw
  - fail2ban
  - htop
  - curl
  - wget

users:
  - name: deploy
    groups: docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGfGX0vqQkD0pPwzqkGsGfA0LwJqVqGVX0vqQkD0pPwz pfandler-deploy"

runcmd:
  # Enable Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Configure firewall
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Create app directory
  - mkdir -p /opt/pfandler
  - chown -R deploy:deploy /opt/pfandler
  
  # Configure swappiness
  - echo "vm.swappiness=10" >> /etc/sysctl.conf
  - sysctl -p